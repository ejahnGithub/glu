name: üêß Linux Smoke Tests

on:
  workflow_call:
  workflow_dispatch:
  push:
    branches-ignore:
      - main
      - 'gh-readonly-queue/**'
  merge_group:

jobs:
  check_changes:
    name: Check if code files changed
    runs-on: ubuntu-latest
    outputs:
      code_changed: ${{ steps.changes.outputs.source_code }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            source_code:
              - 'lib/**'
              - 'include/**'
              - 'tools/**'
              - 'CMakeLists.txt'
              - 'cmake/**'

  linux_smoke_tests:
    name: "linux smoke tests workflow"
    needs: check_changes
    if: needs.check_changes.outputs.code_changed == 'true'
    runs-on: ubuntu-latest
    env:
      LLVM_BIN: /usr/lib/llvm-18/bin
      LLVM_DIR: /usr/lib/llvm-18/cmake
    steps:
      - name: "Install llvm@18 dependencies"
        run:
          sudo apt install -y llvm-18 llvm-18-dev clang-18 libfl-dev llvm-18-tools

      - name: "Install ccache"
        run: |
          sudo apt install -y ccache
          echo '/usr/lib/ccache' >> "$GITHUB_PATH"

      - name: "Install pip dependency"
        run:
          pip install lit

      - name: "Install Flex (and Bison)"
        run: sudo apt install -y flex bison

      - name: Add LLVM tools to PATH
        run: echo "$LLVM_BIN" >> "$GITHUB_PATH"

      - uses: "actions/checkout@v3"
        with:
          fetch-depth: 0

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ccache-${{ runner.os }}-clang18-${{ hashFiles('**/CMakeLists.txt', 'cmake/**') }}
          restore-keys: ccache-${{ runner.os }}-clang18-

      - name: "Configure the project"
        run: |
          export LLVM_VERSION=$(ls /usr/lib/llvm-18 | head -n 1)
          export LLVM_DIR="/usr/lib/llvm-18/cmake"
          export PATH="/usr/lib/llvm-18/bin:$PATH"
          export BISON_EXECUTABLE=$(which bison)
          cmake -B build -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DLLVM_DIR=$LLVM_DIR \
            -DBISON_EXECUTABLE=$BISON_EXECUTABLE \
            -DLLVM_ENABLE_ASSERTIONS=1

      - name: "Run unit tests"
        env:
          ASAN_OPTIONS: detect_leaks=0
        run:
          ./coverage.sh

  linux_tests_summary:
    name: Linux Tests Summary
    runs-on: ubuntu-latest
    needs: [check_changes, linux_smoke_tests]
    if: always()
    steps:
      - name: Check test results
        run: |
          if [[ "${{ needs.check_changes.outputs.code_changed }}" == "false" ]]; then
            echo "‚úÖ No code changes detected, skipping Linux tests"
            exit 0
          elif [[ "${{ needs.linux_smoke_tests.result }}" == "success" ]]; then
            echo "‚úÖ All Linux tests passed"
            exit 0
          else
            echo "‚ùå Linux tests failed"
            exit 1
          fi
